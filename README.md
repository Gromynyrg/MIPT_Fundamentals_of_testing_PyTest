# Booking Service - Тестовый проект с PyTest

Этот проект демонстрирует написание юнит-тестов для простого Booking-сервиса с использованием PyTest.

## Структура проекта

- `services/booking_functions.py`: Содержит реализацию функций Booking-сервиса.
- `tests/test_booking_service.py`: Содержит PyTest-тесты для функций из `booking_service.py`.
- `requirements.txt`: Список зависимостей проекта.
- `README.md`: Этот файл.

## Установка

1.  Клонируйте репозиторий (если он есть) или просто создайте файлы согласно структуре.
2.  Убедитесь, что у вас установлен Python 3.x.
3.  Создайте и активируйте виртуальное окружение (рекомендуется):
    ```bash
    python -m venv venv
    source venv/bin/activate  # для Linux/macOS
    # venv\Scripts\activate    # для Windows
    ```
4.  Установите зависимости:
    ```bash
    pip install -r requirements.txt
    ```

## Запуск тестов

Для запуска всех тестов перейдите в корневую папку проекта (`booking_project`) и выполните команду:

```bash
pytest
```

## Описание тестируемых функций и тестов

Для каждой из 5 основных функций Booking-сервиса написано как минимум 2 позитивных и 2 негативных теста.

### 1. `calc_price(base_price: float, discount: float, count: int) -> float`

Рассчитывает итоговую сумму за `count` билетов с учетом базовой цены и возможной скидки.

-   **Позитивные тесты (`test_calc_booking_cost_positive`):**
    -   Проверяют корректность расчета с различными валидными значениями цены, скидки (включая 0% и 100%) и количества билетов (включая 0).
    -   Используется `pytest.approx` для сравнения чисел с плавающей запятой.
-   **Негативные тесты (`test_calc_booking_cost_negative`):**
    -   Проверяют выброс `ValueError` при отрицательной базовой цене, скидке вне диапазона [0, 1] или отрицательном количестве билетов.
    -   Проверяют выброс `TypeError` при передаче некорректных типов данных (например, строки вместо числа для количества).
    -   Используется `pytest.raises` для проверки ожидаемых исключений и их сообщений.

### 2. `check_availability(event_id: int, seats_requested: int) -> bool`

Проверяет наличие свободных мест для указанного события.

-   **Позитивные тесты (`test_check_availability_positive`):**
    -   Проверяют, что функция возвращает `True`, когда запрашиваемое количество мест доступно (меньше или равно имеющимся).
    -   Используется `mocker.patch.dict` для мокирования состояния "базы данных" свободных мест (`MOCKED_AVAILABLE_SEATS_DB`) для каждого тестового случая, обеспечивая изоляцию.
-   **Негативные тесты (`test_check_availability_negative`):**
    -   Проверяют, что функция возвращает `False`, когда:
        -   Запрашиваемых мест больше, чем доступно.
        -   Для события нет свободных мест.
        -   Событие не найдено (подразумевается, что в этом случае доступных мест 0).
        -   Запрошено 0 или отрицательное количество мест.
    -   Проверяют выброс `TypeError` при некорректных типах `event_id` или `seats_requested`.
    -   Используется `mocker.patch.dict` и `pytest.raises`.

### 3. `apply_promo_code(order_id: int, promo_code: str) -> bool`

Применяет промокод к заказу, если он действителен. (Предполагается, что функция возвращает `bool` для индикации успеха).

-   **Фикстура `fresh_promo_codes_db`:**
    -   Гарантирует, что каждый тест работает с "чистым" и предопределенным состоянием "базы данных" промокодов (`MOCKED_PROMO_CODES_DB`) с помощью `mocker.patch.dict`.
-   **Позитивные тесты (`test_apply_promo_code_positive`):**
    -   Проверяют, что функция возвращает `True` для активных и действительных промокодов.
-   **Негативные тесты (`test_apply_promo_code_negative`):**
    -   Проверяют, что функция возвращает `False` для:
        -   Несуществующих промокодов.
        -   Промокодов с истекшим сроком действия.
        -   Промокодов с исчерпанным лимитом использования.
    -   Проверяют выброс `TypeError`, если `order_id` не число или `promo_code` не строка.
    -   Используется `pytest.raises`.

### 4. `generate_booking_ref(user_id: int, event_id: int) -> str`

Генерирует уникальный код/референс бронирования.

-   **Позитивные тесты (`test_generate_booking_ref_positive_format`):**
    -   Проверяют корректность формата сгенерированной строки (`BOOK-<user_id>-<event_id>-<random_suffix>`).
    -   Проверяется тип, составные части, длина и символы случайного суффикса.
    -   (Опционально, но не в текущей версии тестов: можно было бы мокировать `uuid.uuid4` для проверки уникальности при одинаковых входных данных, если бы это требовалось).
-   **Негативные тесты (`test_generate_booking_ref_negative`):**
    -   Проверяют выброс `ValueError` для невалидных `user_id` или `event_id` (отрицательные или нулевые значения).
    -   Проверяют выброс `TypeError` для некорректных типов `user_id` или `event_id`.
    -   Используется `pytest.raises`.

### 5. `send_notification_email(email: str, booking_details: dict) -> bool`

Имитирует отправку уведомления на почту.

-   **Фикстура `sample_booking_details`:**
    -   Предоставляет стандартный словарь с деталями бронирования для тестов.
-   **Позитивные тесты (`test_send_notification_email_positive`):**
    -   Проверяют, что функция возвращает `True` для валидных email-адресов и деталей бронирования.
    -   Используется `mocker.patch` для мокирования встроенной функции `print` и проверки, что вызов с имитацией отправки был совершен.
-   **Негативные тесты (`test_send_notification_email_negative`):**
    -   Проверяют, что функция возвращает `False` для:
        -   Невалидного формата email.
        -   Пустой строки email.
        -   Пустого словаря `booking_details`.
        -   Специального email "fail@example.com" (имитация сбоя отправки, заложенная в тестируемой функции).
    -   Мокируется `print` для предотвращения вывода в консоль во время негативных тестов.

## Используемые инструменты PyTest

-   **Параметризация (`@pytest.mark.parametrize`)**: Для эффективного тестирования множества сценариев с разными входными данными.
-   **Фикстуры (`@pytest.fixture`)**: Для подготовки общего состояния или данных для тестов (например, `fresh_promo_codes_db`, `sample_booking_details`).
-   **Мок-объекты (`mocker` из `pytest-mock`)**:
    -   `mocker.patch.dict`: Для контроля и изоляции состояния "баз данных" в памяти (`MOCKED_AVAILABLE_SEATS_DB`, `MOCKED_PROMO_CODES_DB`).
    -   `mocker.patch`: Для мокирования функций (например, `builtins.print`).
-   **Проверка исключений (`pytest.raises`)**: Для тестирования корректной обработки ошибок.
-   **Сравнение float (`pytest.approx`)**: Для надежного сравнения чисел с плавающей запятой.

